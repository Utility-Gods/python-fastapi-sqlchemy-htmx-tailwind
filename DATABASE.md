# Database Management Guide

This guide explains how to set up and manage the database for ContentUp.

## Initial Setup

1. **Install PostgreSQL**
```bash
# macOS (using Homebrew)
brew install postgresql@15
brew services start postgresql@15

# Ubuntu/Debian
sudo apt install postgresql-15
sudo systemctl start postgresql
```

2. **Create Database and User**
```bash
# Connect to PostgreSQL as superuser
sudo -u postgres psql

# Create database and user
CREATE DATABASE contentup;
CREATE USER contentup WITH PASSWORD 'contentup123';
GRANT ALL PRIVILEGES ON DATABASE contentup TO contentup;
```

## Database Migrations

1. **Initialize Alembic** (if not already done)
```bash
# Initialize alembic
alembic init alembic
```

2. **Create a Migration**
```bash
# Create a new migration
alembic revision --autogenerate -m "initial tables"
```

3. **Apply Migrations**
```bash
# Apply all pending migrations
alembic upgrade head

# Rollback one migration
alembic downgrade -1

# Rollback to specific migration
alembic downgrade <revision_id>
```

4. **Check Migration Status**
```bash
# View current migration status
alembic current

# View migration history
alembic history --verbose
```

## Common Tasks

### Backup and Restore

1. **Create Backup**
```bash
# Local development
pg_dump -U contentup contentup > backup.sql

# Production
docker exec contentup-db-prod pg_dump -U ${POSTGRES_USER} ${POSTGRES_DB} > backup.sql
```

2. **Restore from Backup**
```bash
# Local development
psql -U contentup contentup < backup.sql

# Production
docker exec -i contentup-db-prod psql -U ${POSTGRES_USER} ${POSTGRES_DB} < backup.sql
```

### Database Reset

1. **Local Development**
```bash
# Drop and recreate database
dropdb -U contentup contentup
createdb -U contentup contentup

# Apply migrations
alembic upgrade head
```

2. **Production**
```bash
# Stop services
docker-compose down

# Remove volume
docker volume rm contentup_postgres_prod_data

# Start services (will recreate DB)
docker-compose up -d

# Apply migrations
docker exec contentup-web-prod alembic upgrade head
```

## Troubleshooting

### Common Issues

1. **Connection Issues**
```bash
# Check PostgreSQL status
sudo systemctl status postgresql

# Check logs
tail -f /var/log/postgresql/postgresql-15-main.log
```

2. **Permission Issues**
```bash
# Grant permissions
sudo -u postgres psql -c "ALTER USER contentup CREATEDB;"
sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE contentup TO contentup;"
```

3. **Migration Issues**
```bash
# Reset alembic version
alembic stamp head

# View SQL for next migration
alembic upgrade head --sql
```

## Best Practices

1. **Migration Guidelines**
   - Always review autogenerated migrations
   - Add data migrations in separate files
   - Test migrations on development before production
   - Back up database before applying migrations

2. **Database Management**
   - Regularly backup production database
   - Monitor database size and performance
   - Keep development database in sync with production schema
   - Use transactions for data modifications

3. **Security**
   - Use strong passwords in production
   - Limit database access to necessary users
   - Regularly update PostgreSQL version
   - Enable SSL for production connections

## Directory Structure
```
contentup/
├── alembic/
│   ├── versions/        # Migration files
│   └── env.py          # Alembic configuration
├── app/
│   ├── models/         # SQLAlchemy models
│   └── db/            # Database utilities
└── alembic.ini        # Alembic settings
``` 